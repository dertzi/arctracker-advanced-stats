// ==UserScript==
// @name         ArcTracker Advanced Stats
// @namespace    violentmonkey
// @version      1.0.15
// @description  Full raid history stats, maps, charts, filter-sync, pagination, gains/losses for ArcTracker.
// @match        https://arctracker.io/raid-history*
// @grant        none
// ==/UserScript==

!function(){"use strict";let t=null,n=null;function e(t){return t.toLocaleString()}function i(t){return new Promise(n=>setTimeout(n,t))}function a(t,n){const e=new URL(t,location.origin);return e.searchParams.set("offset",String(n)),e.toString()}async function r(t){try{const n=await fetch(t,{headers:{"X-ArcStats":"1"}});if(!n.ok)throw new Error("Bad API response");return await n.json()}catch(t){return console.error("[ArcStats] Error fetching page:",t),{raids:[],pagination:{hasMore:!1}}}}const s={"dam-battleground":"Dam Battleground","the-spaceport":"Spaceport","buried-city":"Buried City","blue-gate":"The Blue Gate","stella-montis":"Stella Montis"};function o(t){if(!t||0===t.length)return{totalProfit:0,totalRaids:0,totalSurvived:0,totalKIA:0,avgPerRaid:0,avgPerSurvive:0,profitPerDay:0,days:1,cumulative:[],mapStatsArray:[],biggestGains:[],biggestLosses:[]};let n=0,e=0,i=0,a=null,r=null;const o={};for(const t in s)o[t]={name:s[t],raids:0,survived:0,profit:0};const l=[];t.forEach(t=>{const c=t.effectiveValue??t.totalValueOverride??t.totalValue??0,d=(u=t.raidDate,new Date(u));var u;l.push(c),n+=c,"survived"===t.status?e++:i++,d&&((!a||d<a)&&(a=d),(!r||d>r)&&(r=d)),s[t.mapId]&&(o[t.mapId]||(o[t.mapId]={name:s[t.mapId],raids:0,survived:0,profit:0}),o[t.mapId].raids++,o[t.mapId].profit+=c,"survived"===t.status&&o[t.mapId].survived++)});const c=[];let d=0;l.forEach(t=>{d+=t,c.push(d)});let u=1;if(a&&r){const t=(r-a)/864e5;u=Math.max(1,t)}const m=t.length,v=l.filter(t=>t>0).sort((t,n)=>n-t).slice(0,5),f=l.filter(t=>t<0).sort((t,n)=>t-n).slice(0,5),g=Object.entries(o).map(([t,n])=>{const e=n.raids>0?n.survived/n.raids:0;return{id:t,name:n.name,profit:n.profit,raids:n.raids,survived:n.survived,survivalRate:e}});return{totalProfit:n,totalRaids:m,totalSurvived:e,totalKIA:i,avgPerRaid:m?n/m:0,avgPerSurvive:e?n/e:0,profitPerDay:n/u,days:u,cumulative:c,mapStatsArray:g,biggestGains:v,biggestLosses:f}}function l(t){return"number"==typeof t.totalValueOverride?t.totalValueOverride:"number"==typeof t.effectiveValue?t.effectiveValue:"N/A"}function c(t,n,e){const{min:i,range:a}=n;return e-(t-i)/a*e}function d(t,n,e){return n<=1?0:t/(n-1)*e}function u(t,n,i,a){const r=t._chartData,s=t._chartRanges;r&&s&&(t.onmousemove=s=>{const o=t.getBoundingClientRect(),l=s.clientX-o.left,c=s.clientY-o.top,d=t.width,u=t.height,m=function(t,n,e){const i=n.length;if(i<=1)return 0;const a=Math.round(t/e*(i-1));return Math.max(0,Math.min(i-1,a))}(l,r,d),v=r[m],f=m+1,g=v.cumulative;let p=v.gain;p="N/A"===p?"N/A":e(p),n.innerHTML=`Raid #${f}<br>Cumulative: ${e(g)}<br>Gain/Loss: ${p}`;let h=l+10,x=c+10;h+n.offsetWidth>d&&(h=l-n.offsetWidth-10),x+n.offsetHeight>u&&(x=c-n.offsetHeight-10),n.style.left=h+"px",n.style.top=x+"px",n.style.display="block";const b=t.getContext("2d");a(i),b.strokeStyle="rgba(255,255,255,0.25)",b.setLineDash([4,4]),b.beginPath(),b.moveTo(l,0),b.lineTo(l,u),b.stroke(),b.setLineDash([])},t.onmouseleave=()=>{n.style.display="none",a(i)})}function m(t){const n=t._rawRaidList;if(!n||0===n.length)return;const i=document.getElementById("arcChart"),a=document.getElementById("arcTooltip");if(!i)return;const r=i.getContext("2d");if(!r)return;const s=i.clientWidth,o=i.clientHeight;i.width=s,i.height=o;const v=function(t){const n=[];let e=0;const i=t.slice().reverse();for(let t=0;t<i.length;t++){const a=l(i[t]);"number"==typeof a&&(e+=a),n.push({cumulative:e,gain:a,index:t})}return n}(n),f=function(t){let n=1/0,e=-1/0;for(const i of t)i.cumulative<n&&(n=i.cumulative),i.cumulative>e&&(e=i.cumulative);return n===e&&(n-=1,e+=1),{min:n,max:e,range:e-n}}(v);i._chartData=v,i._chartRanges=f,i._stats=t,function(t,n,i,a,r,s){t.clearRect(0,0,r,s),t.font="10px sans-serif",t.fillStyle="#888";const{min:o,max:l}=a;if(g()){t.strokeStyle="rgba(255,255,255,0.10)",t.lineWidth=1;for(let n=0;n<=4;n++){const e=s/4*n;t.beginPath(),t.moveTo(0,e),t.lineTo(r,e),t.stroke()}}if(o<0&&l>0){const n=c(0,a,s);t.strokeStyle="#aaa",t.lineWidth=1.5,t.beginPath(),t.moveTo(0,n),t.lineTo(r,n),t.stroke(),t.fillText("0",4,n-2)}t.fillText(e(l),4,10),t.fillText(e(o),4,s-4)}(r,0,0,f,s,o),function(t,n,e,i,a,r){t.lineWidth=2,t.beginPath();for(let n=0;n<e.length;n++){const s=d(n,e.length,a),o=c(e[n].cumulative,i,r);0===n?t.moveTo(s,o):t.lineTo(s,o)}const s=i.min>=0,o=i.max<=0;let l;l=s?"rgba(74, 222, 128, 0.25)":o?"rgba(248, 113, 113, 0.25)":"rgba(255, 255, 255, 0.15)",t.lineTo(a,r),t.lineTo(0,r),t.closePath(),t.fillStyle=l,t.fill();for(let n=0;n<e.length-1;n++){const s=d(n,e.length,a),o=c(e[n].cumulative,i,r),l=d(n+1,e.length,a),u=c(e[n+1].cumulative,i,r),m=e[n].cumulative>=0;t.strokeStyle=m?"#4ade80":"#f87171",t.beginPath(),t.moveTo(s,o),t.lineTo(l,u),t.stroke()}}(r,0,v,f,s,o),function(t,n,e,i,a,r){const s=e.map((t,n)=>({gain:t.gain,index:n,cumulative:t.cumulative})).filter(t=>"number"==typeof t.gain);if(0===s.length)return;const o=s.reduce((t,n)=>n.gain>t.gain?n:t,s[0]),l=s.reduce((t,n)=>n.gain<t.gain?n:t,s[0]);function u(n,s){const o=d(n.index,e.length,a),l=c(n.cumulative,i,r);t.beginPath(),t.fillStyle=s,t.strokeStyle=s,t.lineWidth=1.5,t.arc(o,l,4,0,2*Math.PI),t.fill(),t.stroke()}o.gain>0&&u(o,"#4ade80"),l.gain<0&&u(l,"#f87171")}(r,0,v,f,s,o),u(i,a,t,m)}let v=null,f=!0;function g(){return f}function p(t){const n=document.querySelectorAll("div[data-slot='card-content']")[0]||null;if(!n)return;v||(v=document.createElement("div"),v.id="arcStatsBlock",v.className="space-y-3 mb-4",n.insertBefore(v,n.children[1]));const i=t.biggestGains.map(t=>`<div class="text-sm text-green-500">+${e(t)}</div>`).join(""),a=t.biggestLosses.map(t=>`<div class="text-sm text-red-500">${e(t)}</div>`).join("");v.innerHTML=`\n            \x3c!-- ROW 1: Combined Stats (75%) + Raid Summary (25%) --\x3e\n            <div class="arc-row-4cols">\n                \x3c!-- COMBINED STATS CARD (75% width = 3/4 columns) --\x3e\n                <div class="arc-span-3 rounded-lg border bg-card p-3">\n                    <div class="flex flex-col md:flex-row gap-4">\n                        \x3c!-- Total Profit Section --\x3e\n                        <div class="flex-1">\n                            <div class="text-xs text-muted-foreground mb-1">Total Profit</div>\n                            <div class="text-xl font-bold ${t.totalProfit>=0?"text-green-500":"text-red-500"}">\n                                ${e(t.totalProfit)}\n                            </div>\n                        </div>\n                        \n                        \x3c!-- Averages Section --\x3e\n                        <div class="flex-1">\n                            <div class="text-xs text-muted-foreground mb-1">Averages</div>\n                            <div class="text-sm">Per Raid: <b>${e(t.avgPerRaid)}</b></div>\n                            <div class="text-sm">Per Survive: <b>${e(t.avgPerSurvive)}</b></div>\n                            <div class="text-sm">Per Day: <b>${e(t.profitPerDay)}</b></div>\n                        </div>\n                        \n                        \x3c!-- Top Gains & Losses Section --\x3e\n                        <div class="flex-1">\n                            <div class="flex flex-row gap-4">\n                                <div class="flex-1">\n                                    <div class="text-xs text-muted-foreground mb-1">Top 5 Gains</div>\n                                    ${i}\n                                </div>\n                                <div class="flex-1">\n                                    <div class="text-xs text-muted-foreground mb-1">Top 5 Losses</div>\n                                    ${a}\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n                \n                \x3c!-- RAID SUMMARY CARD (25% width = 1/4 columns) --\x3e\n                <div class="arc-span-1 rounded-lg border bg-card p-3">\n                    <div class="text-xs text-muted-foreground mb-1">Raid Summary</div>\n                    <div class="text-sm">Total: <b>${t.totalRaids}</b></div>\n                    <div class="text-sm text-green-500">Survived: <b>${t.totalSurvived}</b></div>\n                    <div class="text-sm text-red-500">KIA: <b>${t.totalKIA}</b></div>\n                </div>\n            </div>\n            \n            \x3c!-- ROW 2: PROFIT CHART (Full width) --\x3e\n            <div class="rounded-lg border bg-card p-3">\n                <div class="flex justify-between items-center mb-2">\n                    <div class="text-xs text-muted-foreground">Profit Chart</div>\n                    <button id="arcGridToggle" class="text-[10px] px-2 py-1 border rounded hover:bg-accent">\n                        Grids: ON\n                    </button>\n                </div>\n                <div style="position:relative;">\n                    <canvas id="arcChart" style="width:100%; height:200px;"></canvas>\n                    <div id="arcTooltip"\n                        style="\n                            position:absolute;\n                            padding:4px 6px;\n                            background:#0009;\n                            color:white;\n                            font-size:11px;\n                            pointer-events:none;\n                            border-radius:4px;\n                            display:none;\n                        ">\n                    </div>\n                </div>\n            </div>\n            \n            \x3c!-- ROW 3: Histogram (50%) + Map Stats (50%) --\x3e\n            <div class="arc-row-2cols">\n                \x3c!-- HISTOGRAM (50% width = 1/2 columns) --\x3e\n                <div class="arc-span-1 rounded-lg border bg-card p-3">\n                    <div class="flex justify-between items-center mb-2">\n                        <div class="text-xs text-muted-foreground">Profit Distribution</div>\n                    </div>\n                    <div style="position:relative;">\n                        <canvas id="arcHistogram" style="width:100%; height:180px;"></canvas>\n                        <div id="arcHistTooltip"\n                            style="\n                                position:absolute;\n                                padding:4px 6px;\n                                background:#0009;\n                                color:white;\n                                font-size:11px;\n                                pointer-events:none;\n                                border-radius:4px;\n                                display:none;\n                            ">\n                        </div>\n                    </div>\n                </div>\n                \n                \x3c!-- MAP STATS (50% width = 1/2 columns) --\x3e\n                <div class="arc-span-1 rounded-lg border bg-card p-3">\n                    <div class="text-xs text-muted-foreground mb-3">Map Stats</div>\n                    <div class="text-[11px] font-semibold text-muted-foreground mb-2" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 0.5rem;">\n                        <div>MAP</div>\n                        <div class="text-right">PROFIT</div>\n                        <div class="text-right">SURVIVAL</div>\n                        <div class="text-right">RAIDS</div>\n                        <div class="text-right">SURVIVED</div>\n                    </div>\n                    <div id="arcMapStatsRows" class="space-y-1"></div>\n                </div>\n            </div>\n        `;const r=document.getElementById("arcGridToggle");r&&(r.onclick=()=>{var n;n=!g(),f=n,r.textContent="Grids: "+(g()?"ON":"OFF"),m(t)}),m(t),function(t){const n=document.getElementById("arcMapStatsRows");if(!n)return;const i=(a=t.mapStatsArray,a.slice().sort((t,n)=>n.profit!==t.profit?n.profit-t.profit:n.survivalRate!==t.survivalRate?n.survivalRate-t.survivalRate:n.raids-t.raids));var a;n.innerHTML=i.map(t=>{const n=t.profit>=0?"text-green-500":"text-red-500";let i="text-red-500";t.survivalRate>.7?i="text-green-500":t.survivalRate>.5&&(i="text-yellow-400");const a=Math.round(100*t.survivalRate);return`\n            <div class="items-center py-1 border-b border-muted/20" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 1fr; gap: 0.5rem;">\n\n                \x3c!-- MAP NAME --\x3e\n                <div class="text-sm">${t.name}</div>\n\n                \x3c!-- PROFIT --\x3e\n                <div class="text-sm font-bold text-right ${n}">\n                    ${t.profit>=0?"+":""}${e(t.profit)}\n                </div>\n\n                \x3c!-- SURVIVAL PERCENTAGE --\x3e\n                <div class="text-sm text-right font-semibold ${i}">\n                    ${a}%\n                </div>\n\n                \x3c!-- RAIDS --\x3e\n                <div class="text-sm text-right">${t.raids}</div>\n\n                \x3c!-- SURVIVED --\x3e\n                <div class="text-sm text-right">${t.survived}</div>\n\n            </div>\n        `}).join("")}(t)}function h(t){return"number"==typeof t.totalValueOverride?t.totalValueOverride:"number"==typeof t.effectiveValue?t.effectiveValue:0}function x(t,n){return Math.round(t/n)*n}function b(t){return t<2e4?500:t<8e4?1e3:t<2e5?2500:5e3}function y(t){if(0===t.length)return 0;return t.slice().sort((t,n)=>t-n)[Math.floor(t.length/2)]}function S(t){if(!t||0===t.length)return[];const n=t.map(h),e=n.filter(t=>t<0),i=n.filter(t=>t>0),a=n.length,r=(s=a,Math.max(4,Math.min(15,Math.ceil(Math.log2(s)+1))));var s;let o=Math.max(1,Math.round(e.length/a*(r-1))),l=Math.max(1,Math.round(i.length/a*(r-1)));const c=function(t,n,e,i){const a=t+n+e-i;return a>0?n>t?{binNeg:t,binPos:n-a}:{binNeg:t-a,binPos:n}:a<0?n>t?{binNeg:t,binPos:n+-a}:{binNeg:t+-a,binPos:n}:{binNeg:t,binPos:n}}(o,l,1,r);o=c.binNeg,l=c.binPos;const d=Math.min(...e,0),u=Math.max(...e,0),m=Math.min(...i,0),v=Math.max(...i,0),f=function(t,n,e,i,a,r){const s=[];if(t.length>0){const n=Math.min(...t),i=(Math.max(...t)-n)/e;for(let t=0;t<e;t++)s.push({min:x(n+t*i,a),max:x(n+(t+1)*i,a),values:[],type:"loss"})}if(s.push({min:0,max:0,values:[],type:"zero"}),n.length>0){const t=Math.min(...n),e=(Math.max(...n)-t)/i;for(let n=0;n<i;n++)s.push({min:x(t+n*e,r),max:x(t+(n+1)*e,r),values:[],type:"gain"})}return s}(e,i,o,l,b(Math.abs(d-u)),b(Math.abs(v-m)));return function(t,n){for(const e of t)for(const t of n){if("zero"===t.type&&0===e){t.values.push(e);break}if(e>=t.min&&e<t.max&&"zero"!==t.type){t.values.push(e);break}}}(n,f),function(t){return t.map(t=>({min:t.min,max:t.max,count:t.values.length,median:y(t.values),type:t.type}))}(f)}function R(t){const n=t._rawRaidList;if(!n||0===n.length)return;const i=document.getElementById("arcHistogram");if(!i)return;const a=i.getContext("2d");if(!a)return;const r=i.clientWidth,s=i.clientHeight;i.width=r,i.height=s;const o=S(n);if(!o||0===o.length)return;i._histBuckets=o,i._histBucketsRaw=n;const l=Math.max(...o.map(t=>t.count),1),c=r/o.length,d=Math.max(2,.18*c);a.clearRect(0,0,r,s),a.strokeStyle="rgba(255,255,255,0.2)",a.beginPath(),a.moveTo(0,s-1),a.lineTo(r,s-1),a.stroke(),o.forEach((t,n)=>{const i=n*c+d/2,r=t.count/l*(.75*s),o=s-r;let u;u="loss"===t.type?"rgba(248, 113, 113, 0.55)":"gain"===t.type?"rgba(74, 222, 128, 0.55)":"rgba(148, 163, 184, 0.45)",a.fillStyle=u,a.fillRect(i,o,c-d,r),a.fillStyle="#ccc",a.font="10px sans-serif",(c>55||n%2==0)&&a.fillText(`${e(t.min)} → ${e(t.max)}`,i,s-4)})}function w(t){const n=document.getElementById("arcHistogram");if(!n)return;R(t);!function(t,n){const i=t._histBuckets;if(!i||0===i.length)return;const a=t.width,r=t.height,s=a/i.length;t.onmousemove=o=>{const l=t.getBoundingClientRect(),c=o.clientX-l.left,d=Math.floor(c/s);if(d<0||d>=i.length)return n.style.display="none",void R({_rawRaidList:t._histBucketsRaw});const u=i[d];let m;m="zero"===u.type?"0 → 0":`${e(u.min)} → ${e(u.max)}`;const v="loss"===(f=u.type)?"Loss":"gain"===f?"Gain":"Zero";var f;n.innerHTML=`\n                Range: ${m}<br>\n                Raids: ${u.count}<br>\n                Median: ${e(u.median)}<br>\n                Type: ${v}\n            `;let g=c+12;g+n.offsetWidth>a&&(g=c-n.offsetWidth-12),n.style.left=g+"px",n.style.top="16px",n.style.display="block",R({_rawRaidList:t._histBucketsRaw});const p=t.getContext("2d");p.save(),p.strokeStyle="rgba(255,255,255,0.35)",p.lineWidth=2,p.strokeRect(d*s+1,1,s-2,r-2),p.restore()},t.onmouseleave=()=>{n.style.display="none",R({_rawRaidList:t._histBucketsRaw})}}(n,document.getElementById("arcHistTooltip"))}let T=null;function M(t){null!==T&&clearTimeout(T),T=setTimeout(async()=>{console.log("[ArcStats] Filters changed, refreshing...");const n=await async function(t){console.log("[ArcStats] Fetching full raid history with filters:",t);let n=[],e=0;for(;;){const s=a(t,e),o=await r(s);if(!o.raids||0===o.raids.length)break;if(n=n.concat(o.raids),!o.pagination?.hasMore)break;e+=20,await i(120)}return console.log(`[ArcStats] Loaded ${n.length} total raids.`),n}(t),e=o(n);e._rawRaidList=n,p(e),w(e)},300)}!function(){console.log("[ArcStats] Initializing..."),function(){if(document.getElementById("arcStatsCustomStyles"))return;const t=document.createElement("style");t.id="arcStatsCustomStyles",t.textContent="\n    /* =============================================================================\n       ARC STATS CUSTOM GRID SYSTEM\n       Overrides ArcTracker's forced grid-column rules with !important\n       ============================================================================= */\n\n    /* Base container styling */\n    #arcStatsBlock {\n      width: 100% !important;\n      max-width: 100% !important;\n    }\n\n    /* 4-column grid (for 75%/25% or other layouts) */\n    #arcStatsBlock .arc-row-4cols {\n      display: grid !important;\n      grid-template-columns: repeat(4, 1fr) !important;\n      gap: 0.75rem !important;\n      width: 100% !important;\n    }\n\n    /* 2-column grid (for 50%/50% layouts) */\n    #arcStatsBlock .arc-row-2cols {\n      display: grid !important;\n      grid-template-columns: repeat(2, 1fr) !important;\n      gap: 0.75rem !important;\n      width: 100% !important;\n    }\n\n    /* Single column (full-width) */\n    #arcStatsBlock .arc-row-1col {\n      display: block !important;\n      width: 100% !important;\n    }\n\n    /* Column span classes */\n    #arcStatsBlock .arc-span-4 {\n      grid-column: span 4 / span 4 !important;\n    }\n\n    #arcStatsBlock .arc-span-3 {\n      grid-column: span 3 / span 3 !important;\n    }\n\n    #arcStatsBlock .arc-span-2 {\n      grid-column: span 2 / span 2 !important;\n    }\n\n    #arcStatsBlock .arc-span-1 {\n      grid-column: span 1 / span 1 !important;\n    }\n\n    /* Responsive behavior for tablets */\n    @media (max-width: 768px) {\n      #arcStatsBlock .arc-row-4cols {\n        grid-template-columns: repeat(2, 1fr) !important;\n      }\n\n      #arcStatsBlock .arc-span-3 {\n        grid-column: span 2 / span 2 !important;\n      }\n    }\n\n    /* Responsive behavior for mobile */\n    @media (max-width: 640px) {\n      #arcStatsBlock .arc-row-4cols,\n      #arcStatsBlock .arc-row-2cols {\n        grid-template-columns: 1fr !important;\n      }\n\n      #arcStatsBlock .arc-span-4,\n      #arcStatsBlock .arc-span-3,\n      #arcStatsBlock .arc-span-2,\n      #arcStatsBlock .arc-span-1 {\n        grid-column: span 1 / span 1 !important;\n      }\n    }\n  ",document.head.appendChild(t),console.log("[ArcStats] Custom grid styles injected")}(),function(){const e=globalThis.fetch;globalThis.fetch=async function(i,a){try{"string"!=typeof i||!i.includes("/api/raids?")||a?.headers&&"X-ArcStats"in a.headers||(t=i,console.log("[ArcStats] Detected API:",i),n&&n(i))}catch(t){console.error("[ArcStats] API watch error:",t)}return e(i,a)}}(),n=M;t&&M(t),console.log("[ArcStats] Ready!")}()}();
