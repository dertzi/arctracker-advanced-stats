// ==UserScript==
// @name         ArcTracker Advanced Stats
// @namespace    violentmonkey
// @version      1.0.1
// @description  Full raid history stats, maps, charts, filter-sync, pagination, gains/losses for ArcTracker.
// @match        https://arctracker.io/raid-history*
// @grant        none
// ==/UserScript==

!function(){"use strict";let t=null,e=null;function n(t){return t.toLocaleString()}function i(t){return new Promise(e=>setTimeout(e,t))}function a(t,e){const n=new URL(t,location.origin);return n.searchParams.set("offset",String(e)),n.toString()}async function r(t){try{const e=await fetch(t,{headers:{"X-ArcStats":"1"}});if(!e.ok)throw new Error("Bad API response");return await e.json()}catch(t){return console.error("[ArcStats] Error fetching page:",t),{raids:[],pagination:{hasMore:!1}}}}const s={"dam-battleground":"Dam Battleground","the-spaceport":"Spaceport","buried-city":"Buried City","blue-gate":"The Blue Gate","stella-montis":"Stella Montis"};function o(t){if(!t||0===t.length)return{totalProfit:0,totalRaids:0,totalSurvived:0,totalKIA:0,avgPerRaid:0,avgPerSurvive:0,profitPerDay:0,days:1,cumulative:[],mapStatsArray:[],biggestGains:[],biggestLosses:[]};let e=0,n=0,i=0,a=null,r=null;const o={};for(const t in s)o[t]={name:s[t],raids:0,survived:0,profit:0};const l=[];t.forEach(t=>{const d=t.effectiveValue??t.totalValueOverride??t.totalValue??0,c=(u=t.raidDate,new Date(u));var u;l.push(d),e+=d,"survived"===t.status?n++:i++,c&&((!a||c<a)&&(a=c),(!r||c>r)&&(r=c)),s[t.mapId]&&(o[t.mapId]||(o[t.mapId]={name:s[t.mapId],raids:0,survived:0,profit:0}),o[t.mapId].raids++,o[t.mapId].profit+=d,"survived"===t.status&&o[t.mapId].survived++)});const d=[];let c=0;l.forEach(t=>{c+=t,d.push(c)});let u=1;if(a&&r){const t=(r-a)/864e5;u=Math.max(1,t)}const v=t.length,g=l.filter(t=>t>0).sort((t,e)=>e-t).slice(0,5),f=l.filter(t=>t<0).sort((t,e)=>t-e).slice(0,5),m=Object.entries(o).map(([t,e])=>{const n=e.raids>0?e.survived/e.raids:0;return{id:t,name:e.name,profit:e.profit,raids:e.raids,survived:e.survived,survivalRate:n}});return{totalProfit:e,totalRaids:v,totalSurvived:n,totalKIA:i,avgPerRaid:v?e/v:0,avgPerSurvive:n?e/n:0,profitPerDay:e/u,days:u,cumulative:d,mapStatsArray:m,biggestGains:g,biggestLosses:f}}function l(t){return"number"==typeof t.totalValueOverride?t.totalValueOverride:"number"==typeof t.effectiveValue?t.effectiveValue:"N/A"}function d(t,e,n){const{min:i,range:a}=e;return n-(t-i)/a*n}function c(t,e,n){return e<=1?0:t/(e-1)*n}function u(t,e,i,a){const r=t._chartData,s=t._chartRanges;r&&s&&(t.onmousemove=s=>{const o=t.getBoundingClientRect(),l=s.clientX-o.left,d=s.clientY-o.top,c=t.width,u=t.height,v=function(t,e,n){const i=e.length;if(i<=1)return 0;const a=Math.round(t/n*(i-1));return Math.max(0,Math.min(i-1,a))}(l,r,c),g=r[v],f=v+1,m=g.cumulative;let h=g.gain;h="N/A"===h?"N/A":n(h),e.innerHTML=`Raid #${f}<br>Cumulative: ${n(m)}<br>Gain/Loss: ${h}`;let p=l+10,x=d+10;p+e.offsetWidth>c&&(p=l-e.offsetWidth-10),x+e.offsetHeight>u&&(x=d-e.offsetHeight-10),e.style.left=p+"px",e.style.top=x+"px",e.style.display="block";const b=t.getContext("2d");a(i),b.strokeStyle="rgba(255,255,255,0.25)",b.setLineDash([4,4]),b.beginPath(),b.moveTo(l,0),b.lineTo(l,u),b.stroke(),b.setLineDash([])},t.onmouseleave=()=>{e.style.display="none",a(i)})}function v(t){const e=t._rawRaidList;if(!e||0===e.length)return;const i=document.getElementById("arcChart"),a=document.getElementById("arcTooltip");if(!i)return;const r=i.getContext("2d");if(!r)return;const s=i.clientWidth,o=i.clientHeight;i.width=s,i.height=o;const g=function(t){const e=[];let n=0;const i=t.slice().reverse();for(let t=0;t<i.length;t++){const a=l(i[t]);"number"==typeof a&&(n+=a),e.push({cumulative:n,gain:a,index:t})}return e}(e),m=function(t){let e=1/0,n=-1/0;for(const i of t)i.cumulative<e&&(e=i.cumulative),i.cumulative>n&&(n=i.cumulative);return e===n&&(e-=1,n+=1),{min:e,max:n,range:n-e}}(g);i._chartData=g,i._chartRanges=m,i._stats=t,function(t,e,i,a,r,s){t.clearRect(0,0,r,s),t.font="10px sans-serif",t.fillStyle="#888";const{min:o,max:l}=a;if(f){t.strokeStyle="rgba(255,255,255,0.10)",t.lineWidth=1;for(let e=0;e<=4;e++){const n=s/4*e;t.beginPath(),t.moveTo(0,n),t.lineTo(r,n),t.stroke()}}if(o<0&&l>0){const e=d(0,a,s);t.strokeStyle="#aaa",t.lineWidth=1.5,t.beginPath(),t.moveTo(0,e),t.lineTo(r,e),t.stroke(),t.fillText("0",4,e-2)}t.fillText(n(l),4,10),t.fillText(n(o),4,s-4)}(r,0,0,m,s,o),function(t,e,n,i,a,r){t.lineWidth=2,t.beginPath();for(let e=0;e<n.length;e++){const s=c(e,n.length,a),o=d(n[e].cumulative,i,r);0===e?t.moveTo(s,o):t.lineTo(s,o)}const s=i.min>=0,o=i.max<=0;let l;l=s?"rgba(74, 222, 128, 0.25)":o?"rgba(248, 113, 113, 0.25)":"rgba(255, 255, 255, 0.15)",t.lineTo(a,r),t.lineTo(0,r),t.closePath(),t.fillStyle=l,t.fill();for(let e=0;e<n.length-1;e++){const s=c(e,n.length,a),o=d(n[e].cumulative,i,r),l=c(e+1,n.length,a),u=d(n[e+1].cumulative,i,r),v=n[e].cumulative>=0;t.strokeStyle=v?"#4ade80":"#f87171",t.beginPath(),t.moveTo(s,o),t.lineTo(l,u),t.stroke()}}(r,0,g,m,s,o),function(t,e,n,i,a,r){const s=n.map((t,e)=>({gain:t.gain,index:e,cumulative:t.cumulative})).filter(t=>"number"==typeof t.gain);if(0===s.length)return;const o=s.reduce((t,e)=>e.gain>t.gain?e:t),l=s.reduce((t,e)=>e.gain<t.gain?e:t);function u(e,s){const o=c(e.index,n.length,a),l=d(e.cumulative,i,r);t.beginPath(),t.fillStyle=s,t.strokeStyle=s,t.lineWidth=1.5,t.arc(o,l,4,0,2*Math.PI),t.fill(),t.stroke()}o.gain>0&&u(o,"#4ade80"),l.gain<0&&u(l,"#f87171")}(r,0,g,m,s,o),u(i,a,t,v)}let g=null,f=!0;function m(t){const e=document.querySelectorAll("div[data-slot='card-content']")[0]||null;if(!e)return;g||(g=document.createElement("div"),g.id="arcStatsBlock",g.className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mb-4",e.insertBefore(g,e.children[1]));const i=t.biggestGains.map(t=>`<div class="text-sm text-green-500">+${n(t)}</div>`).join(""),a=t.biggestLosses.map(t=>`<div class="text-sm text-red-500">${n(t)}</div>`).join("");g.innerHTML=`\n            <div class="rounded-lg border bg-card p-3">\n                <div class="text-xs text-muted-foreground mb-1">Total Profit</div>\n                <div class="text-xl font-bold ${t.totalProfit>=0?"text-green-500":"text-red-500"}">\n                    ${n(t.totalProfit)}\n                </div>\n            </div>\n            <div class="rounded-lg border bg-card p-3">\n                <div class="text-xs text-muted-foreground mb-1">Raid Summary</div>\n                <div class="text-sm">Total: <b>${t.totalRaids}</b></div>\n                <div class="text-sm text-green-500">Survived: <b>${t.totalSurvived}</b></div>\n                <div class="text-sm text-red-500">KIA: <b>${t.totalKIA}</b></div>\n            </div>\n            <div class="rounded-lg border bg-card p-3">\n                <div class="text-xs text-muted-foreground mb-1">Averages</div>\n                <div class="text-sm">Per Raid: <b>${n(t.avgPerRaid)}</b></div>\n                <div class="text-sm">Per Survive: <b>${n(t.avgPerSurvive)}</b></div>\n                <div class="text-sm">Per Day: <b>${n(t.profitPerDay)}</b></div>\n            </div>\n            \x3c!-- PROFIT CHART --\x3e\n            <div class="rounded-lg border bg-card p-3 md:col-span-2 lg:col-span-3">\n                <div class="flex justify-between items-center mb-2">\n                    <div class="text-xs text-muted-foreground">Profit Chart</div>\n                    <button id="arcGridToggle" class="text-[10px] px-2 py-1 border rounded hover:bg-accent">\n                        Grids: ON\n                    </button>\n                </div>\n                <div style="position:relative;">\n                    <canvas id="arcChart" style="width:100%; height:200px;"></canvas>\n                    <div id="arcTooltip"\n                        style="\n                            position:absolute;\n                            padding:4px 6px;\n                            background:#0009;\n                            color:white;\n                            font-size:11px;\n                            pointer-events:none;\n                            border-radius:4px;\n                            display:none;\n                        ">\n                    </div>\n                </div>\n            </div>\n            \x3c!-- NEW MAP STATS CARD (FULL WIDTH, AFTER PROFIT CHART) --\x3e\n            <div class="rounded-lg border bg-card p-3 md:col-span-2 lg:col-span-3">\n                <div class="text-xs text-muted-foreground mb-3">Map Stats</div>\n                <div class="grid grid-cols-[2fr,1fr,2fr,1fr,1fr] text-[11px] font-semibold text-muted-foreground mb-2">\n                    <div>MAP</div>\n                    <div class="text-right">PROFIT</div>\n                    <div class="text-center">SURVIVAL</div>\n                    <div class="text-right">RAIDS</div>\n                    <div class="text-right">SURVIVED</div>\n                </div>\n                <div id="arcMapStatsRows" class="space-y-1"></div>\n            </div>\n            \x3c!-- TOP GAINS --\x3e\n            <div class="rounded-lg border bg-card p-3">\n                <div class="text-xs text-muted-foreground mb-1">Top 5 Gains</div>\n                ${i}\n            </div>\n            \x3c!-- TOP LOSSES --\x3e\n            <div class="rounded-lg border bg-card p-3">\n                <div class="text-xs text-muted-foreground mb-1">Top 5 Losses</div>\n                ${a}\n            </div>\n            \x3c!-- HISTOGRAM --\x3e\n            <div class="rounded-lg border bg-card p-3 md:col-span-2 lg:col-span-3">\n                <div class="flex justify-between items-center mb-2">\n                    <div class="text-xs text-muted-foreground">Profit Distribution</div>\n                </div>\n                <div style="position:relative;">\n                    <canvas id="arcHistogram" style="width:100%; height:180px;"></canvas>\n                    <div id="arcHistTooltip"\n                        style="\n                            position:absolute;\n                            padding:4px 6px;\n                            background:#0009;\n                            color:white;\n                            font-size:11px;\n                            pointer-events:none;\n                            border-radius:4px;\n                            display:none;\n                        ">\n                    </div>\n                </div>\n            </div>\n        `;const r=document.getElementById("arcGridToggle");r&&(r.onclick=()=>{f=!f,r.textContent="Grids: "+(f?"ON":"OFF"),v(t)}),v(t),function(t){const e=document.getElementById("arcMapStatsRows");if(!e)return;const i=(a=t.mapStatsArray,a.slice().sort((t,e)=>e.profit!==t.profit?e.profit-t.profit:e.survivalRate!==t.survivalRate?e.survivalRate-t.survivalRate:e.raids-t.raids));var a;e.innerHTML=i.map(t=>{const e=t.profit>=0?"text-green-500":"text-red-500";let i="bg-red-500";t.survivalRate>.7?i="bg-green-500":t.survivalRate>.5&&(i="bg-yellow-400");const a=Math.round(100*t.survivalRate);return`\n            <div class="grid grid-cols-[2fr,1fr,2fr,1fr,1fr] items-center py-1 border-b border-muted/20">\n\n                \x3c!-- MAP NAME --\x3e\n                <div class="text-sm">${t.name}</div>\n\n                \x3c!-- PROFIT --\x3e\n                <div class="text-sm font-bold text-right ${e}">\n                    ${t.profit>=0?"+":""}${n(t.profit)}\n                </div>\n\n                \x3c!-- SURVIVAL BAR + PERCENT --\x3e\n                <div class="px-2">\n                    <div class="w-full h-2 bg-muted rounded overflow-hidden">\n                        <div class="h-full ${i}" style="width: ${a}%;"></div>\n                    </div>\n                    <div class="text-[10px] text-center mt-1">${a}%</div>\n                </div>\n\n                \x3c!-- RAIDS --\x3e\n                <div class="text-sm text-right">${t.raids}</div>\n\n                \x3c!-- SURVIVED --\x3e\n                <div class="text-sm text-right">${t.survived}</div>\n\n            </div>\n        `}).join("")}(t)}function h(t){return"number"==typeof t.totalValueOverride?t.totalValueOverride:"number"==typeof t.effectiveValue?t.effectiveValue:0}function p(t,e){return Math.round(t/e)*e}function x(t){return t<2e4?500:t<8e4?1e3:t<2e5?2500:5e3}function b(t){if(!t||0===t.length)return[];const e=t.map(h),n=e.filter(t=>t<0),i=e.filter(t=>t>0),a=e.length,r=(s=a,Math.max(4,Math.min(15,Math.ceil(Math.log2(s)+1))));var s;let o=Math.max(1,Math.round(n.length/a*(r-1))),l=Math.max(1,Math.round(i.length/a*(r-1)));let d=o+l+1-r;d>0?l>o?l-=d:o-=d:d<0&&(l>o?l+=-d:o+=-d);const c=Math.min(...n,0),u=Math.max(...n,0),v=Math.min(...i,0),g=Math.max(...i,0),f=x(Math.abs(c-u)),m=x(Math.abs(g-v)),b=[];if(n.length>0){const t=(u-c)/o;for(let e=0;e<o;e++)b.push({min:p(c+e*t,f),max:p(c+(e+1)*t,f),values:[],type:"loss"})}if(b.push({min:0,max:0,values:[],type:"zero"}),i.length>0){const t=(g-v)/l;for(let e=0;e<l;e++)b.push({min:p(v+e*t,m),max:p(v+(e+1)*t,m),values:[],type:"gain"})}for(const t of e)for(const e of b){if("zero"===e.type&&0===t){e.values.push(t);break}if(t>=e.min&&t<e.max&&"zero"!==e.type){e.values.push(t);break}}return b.map(t=>({min:t.min,max:t.max,count:t.values.length,median:t.values.length?t.values.slice().sort((t,e)=>t-e)[Math.floor(t.values.length/2)]:0,type:t.type}))}function y(t){const e=t._rawRaidList;if(!e||0===e.length)return;const i=document.getElementById("arcHistogram");if(!i)return;const a=i.getContext("2d");if(!a)return;const r=i.clientWidth,s=i.clientHeight;i.width=r,i.height=s;const o=b(e);if(!o||0===o.length)return;i._histBuckets=o,i._histBucketsRaw=e;const l=Math.max(...o.map(t=>t.count),1),d=r/o.length,c=Math.max(2,.18*d);a.clearRect(0,0,r,s),a.strokeStyle="rgba(255,255,255,0.2)",a.beginPath(),a.moveTo(0,s-1),a.lineTo(r,s-1),a.stroke(),o.forEach((t,e)=>{const i=e*d+c/2,r=t.count/l*(.75*s),o=s-r;let u;u="loss"===t.type?"rgba(248, 113, 113, 0.55)":"gain"===t.type?"rgba(74, 222, 128, 0.55)":"rgba(148, 163, 184, 0.45)",a.fillStyle=u,a.fillRect(i,o,d-c,r),a.fillStyle="#ccc",a.font="10px sans-serif",(d>55||e%2==0)&&a.fillText(`${n(t.min)} → ${n(t.max)}`,i,s-4)})}function R(t){const e=document.getElementById("arcHistogram");if(!e)return;y(t);!function(t,e){const i=t._histBuckets;if(!i||0===i.length)return;const a=t.width,r=t.height,s=a/i.length;t.onmousemove=o=>{const l=t.getBoundingClientRect(),d=o.clientX-l.left,c=Math.floor(d/s);if(c<0||c>=i.length)return e.style.display="none",void y({_rawRaidList:t._histBucketsRaw});const u=i[c];let v;v="zero"===u.type?"0 → 0":`${n(u.min)} → ${n(u.max)}`;const g="loss"===u.type?"Loss":"gain"===u.type?"Gain":"Zero";e.innerHTML=`\n                Range: ${v}<br>\n                Raids: ${u.count}<br>\n                Median: ${n(u.median)}<br>\n                Type: ${g}\n            `;let f=d+12;f+e.offsetWidth>a&&(f=d-e.offsetWidth-12),e.style.left=f+"px",e.style.top="16px",e.style.display="block",y({_rawRaidList:t._histBucketsRaw});const m=t.getContext("2d");m.save(),m.strokeStyle="rgba(255,255,255,0.35)",m.lineWidth=2,m.strokeRect(c*s+1,1,s-2,r-2),m.restore()},t.onmouseleave=()=>{e.style.display="none",y({_rawRaidList:t._histBucketsRaw})}}(e,document.getElementById("arcHistTooltip"))}let S=null;function T(t){null!==S&&clearTimeout(S),S=setTimeout(async()=>{console.log("[ArcStats] Filters changed, refreshing...");const e=await async function(t){console.log("[ArcStats] Fetching full raid history with filters:",t);let e=[],n=0;for(;;){const s=a(t,n),o=await r(s);if(!o.raids||0===o.raids.length)break;if(e=e.concat(o.raids),!o.pagination?.hasMore)break;n+=20,await i(120)}return console.log(`[ArcStats] Loaded ${e.length} total raids.`),e}(t),n=o(e);n._rawRaidList=e,m(n),R(n)},300)}!function(){console.log("[ArcStats] Initializing..."),function(){const n=globalThis.fetch;globalThis.fetch=async function(i,a){try{"string"!=typeof i||!i.includes("/api/raids?")||a?.headers&&"X-ArcStats"in a.headers||(t=i,console.log("[ArcStats] Detected API:",i),e&&e(i))}catch(t){console.error("[ArcStats] API watch error:",t)}return n(i,a)}}(),e=T;t&&T(t),console.log("[ArcStats] Ready!")}()}();
